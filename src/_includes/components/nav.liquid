{%- comment -%}

Inputs:
Params (all optional):
	•	nodes – array for one manual (usually manualNodes | where: "manual", <slug>).
	•	root – node id (e.g. "300" or "110") or omit for “all top-level pages”.
	•	max_depth – how many levels to render from the chosen root(s). Default: big (e.g. 99).
	•	list – "dl" (default) or "ul".
	•	show_pages – default true.
	•	show_headings – default false (turn on for full index or page sidebar).
	•	hide_top_singles – default false. If true, don’t show 301/402/507 at the topmost level rendered.
	•	nest_singles_under_group – default false. If true and root is a group like "300", include its 301/… under that root.
{%- endcomment -%}

{%- assign _nodes   = nodes   | default: manualNodes -%}
{%- assign _mode    = mode    | default: "manual" -%}
{%- assign _opts    = options -%}

{%- assign _list_kind = _opts.list_kind | default: "dl" -%}
{%- assign _depth     = _opts.show_depth -%}
{%- if _depth == nil -%}
  {%- case _mode -%}
    {%- when "page"   -%}{% assign _depth = 3 %}
    {%- when "manual" -%}{% assign _depth = 2 %}
    {%- when "series" -%}{% assign _depth = 2 %}
    {%- when "full"   -%}{% assign _depth = 99 %}
    {%- else          -%}{% assign _depth = 2 %}
  {%- endcase -%}
{%- endif -%}

{%- assign _omitTopSingles = _opts.omitSinglesAtTop | default: false -%}
{%- assign _fileSingles    = _opts.fileSinglesUnderGroup | default: false -%}
{%- assign _withHeadings   = _opts.includeHeadings | default: false -%}

{%- assign _root = root -%}
{%- if _root and _root.node_id == nil -%}
  {%- assign _root = _nodes | where: "node_id", _root | first -%}
{%- endif -%}

{%- case _mode -%}

  {%- when "manual" -%}
    {%- assign tops = _nodes | where:"type","page" | where:"level",0 | sort:"group" -%}
    {%- if _list_kind == "dl" -%}
      <dl class="toc list-unstyled">
        {%- for t in tops -%}
          <dt><a href="{{ t.permalink }}">{{ t.title }}</a></dt>
          <dd>
            {% render "components/_nav_render.liquid",
              nodes: _nodes,
              parent_id: t.node_id,
              kind: "pages",
              list_kind: "ul",
              depth: _depth,                 /* depth counts child levels to show */
              mode: _mode,
              omitSingles: _omitTopSingles,
              singlesToGroup: false
            %}
            {%- if _withHeadings -%}
              {% render "components/_nav_render.liquid",
                nodes: _nodes,
                parent_id: t.node_id,
                kind: "headings",
                list_kind: "ul",
                depth: _depth,
                mode: _mode,
                omitSingles: false,
                singlesToGroup: false
              %}
            {%- endif -%}
          </dd>
        {%- endfor -%}
      </dl>
    {%- else -%}
      <ul class="list-unstyled">
        {%- for t in tops -%}
          <li>
            <a href="{{ t.permalink }}">{{ t.title }}</a>
            {% render "components/_nav_render.liquid",
              nodes: _nodes,
              parent_id: t.node_id,
              kind: "pages",
              list_kind: _list_kind,
              depth: _depth,
              mode: _mode,
              omitSingles: _omitTopSingles,
              singlesToGroup: false
            %}
            {%- if _withHeadings -%}
              {% render "components/_nav_render.liquid",
                nodes: _nodes,
                parent_id: t.node_id,
                kind: "headings",
                list_kind: _list_kind,
                depth: _depth,
                mode: _mode,
                omitSingles: false,
                singlesToGroup: false
              %}
            {%- endif -%}
          </li>
        {%- endfor -%}
      </ul>
    {%- endif -%}

  {%- when "series" -%}
    {%- if _root -%}
      {% render "components/_nav_render.liquid",
        nodes: _nodes,
        parent_id: _root.node_id,
        kind: "pages",
        list_kind: _list_kind,
        depth: _depth,
        mode: _mode,
        omitSingles: false,
        singlesToGroup: _fileSingles
      %}
    {%- else -%}
      <p class="text-danger">Series nav: missing root.</p>
    {%- endif -%}

  {%- when "page" -%}
    {%- if _root -%}
      {% render "components/_nav_render.liquid",
        nodes: _nodes,
        parent_id: _root.node_id,
        kind: "headings",
        list_kind: _list_kind,
        depth: _depth,
        mode: _mode,
        omitSingles: false,
        singlesToGroup: false
      %}
    {%- else -%}
      <p class="text-danger">Page nav: missing root.</p>
    {%- endif -%}

  {%- when "full" -%}
    {%- assign tops = _nodes | where:"type","page" | where:"level",0 | sort:"group" -%}
    <dl class="toc list-unstyled">
      {%- for t in tops -%}
        <dt><a href="{{ t.permalink }}">{{ t.title }}</a></dt>
        <dd>
          {% render "components/_nav_render.liquid",
            nodes: _nodes,
            parent_id: t.node_id,
            kind: "pages",
            list_kind: "ul",
            depth: _depth,
            mode: _mode,
            omitSingles: false,
            singlesToGroup: false
          %}
          {% render "components/_nav_render.liquid",
            nodes: _nodes,
            parent_id: t.node_id,
            kind: "headings",
            list_kind: "ul",
            depth: _depth,
            mode: _mode,
            omitSingles: false,
            singlesToGroup: false
          %}
        </dd>
      {%- endfor -%}
    </dl>

  {%- else -%}
    <p class="text-danger">Unknown nav mode: {{ _mode }}</p>
{%- endcase -%}