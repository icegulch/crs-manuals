{%- comment -%}
Recursive renderer for nav.

Inputs
- nodes:    array of node objects (already filtered to one manual)
- parent_id: node_id whose direct children we want to render
- kind:     "pages" or "headings"
- list_kind:"dl" or "ul"
- depth:    integer; how many levels of *children* to render (1 = just direct kids)
- mode:     "manual" | "series" | "page" | "full"
- omitSingles: bool (omit level-1 pages whose node_id does not end with 0)
- singlesToGroup: bool (currently unused)
{%- endcomment -%}

{%- assign _all = nodes | where: "parent_node", parent_id -%}
{%- if kind == "pages" -%}
  {%- assign children = _all | where: "type", "page" -%}
{%- elsif kind == "headings" -%}
  {%- assign children = _all | where: "type", "heading" -%}
{%- else -%}
  {%- assign children = _all -%}
{%- endif -%}

{%- if omitSingles -%}
  {%- assign filtered = "" | split: "" -%}
  {%- for c in children -%}
    {%- assign last = c.node_id | slice: -1, 1 -%}
    {%- if c.level != 1 or last == "0" -%}
      {%- assign filtered = filtered | push: c -%}
    {%- endif -%}
  {%- endfor -%}
  {%- assign children = filtered -%}
{%- endif -%}

{%- if children.size == 0 -%}
  {%- comment -%}no children to render{%- endcomment -%}
{%- endif -%}

{%- if children.size > 0 -%}
  {%- if list_kind == "dl" -%}
    <dl class="toc list-unstyled ms-3">
      {%- for c in children -%}
        <dt><a href="{{ c.permalink }}">{{ c.title }}</a></dt>
        <dd>
          {%- if depth > 1 -%}
            {% render "components/_nav_render.liquid",
              nodes: nodes,
              parent_id: c.node_id,
              kind: kind,
              list_kind: list_kind,
              depth: depth | minus: 1,
              mode: mode,
              omitSingles: omitSingles,
              singlesToGroup: singlesToGroup
            %}
            {%- if mode == "full" and kind == "pages" -%}
              {% render "components/_nav_render.liquid",
                nodes: nodes,
                parent_id: c.node_id,
                kind: "headings",
                list_kind: "ul",
                depth: depth | minus: 1,
                mode: mode,
                omitSingles: false,
                singlesToGroup: false
              %}
            {%- endif -%}
          {%- endif -%}
        </dd>
      {%- endfor -%}
    </dl>
  {%- else -%}
    <ul class="list-unstyled ms-3" role="list">
      {%- for c in children -%}
        <li>
          <a href="{{ c.permalink }}">{{ c.title }}</a>
          {%- if depth > 1 -%}
            {% render "components/_nav_render.liquid",
              nodes: nodes,
              parent_id: c.node_id,
              kind: kind,
              list_kind: list_kind,
              depth: depth | minus: 1,
              mode: mode,
              omitSingles: omitSingles,
              singlesToGroup: singlesToGroup
            %}
            {%- if mode == "full" and kind == "pages" -%}
              {% render "components/_nav_render.liquid",
                nodes: nodes,
                parent_id: c.node_id,
                kind: "headings",
                list_kind: "ul",
                depth: depth | minus: 1,
                mode: mode,
                omitSingles: false,
                singlesToGroup: false
              %}
            {%- endif -%}
          {%- endif -%}
        </li>
      {%- endfor -%}
    </ul>
  {%- endif -%}
{%- endif -%}